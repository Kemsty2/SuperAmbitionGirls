"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _http = require("http");

var _isPlainObject = _interopRequireDefault(require("../../lib/util/isPlainObject"));

var _isFile = _interopRequireDefault(require("../../lib/isFile"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const isArray = Array.isArray;
const entries = Object.entries;

async function mapFiles(obj, cb, ctx) {
  const res = isArray(obj) ? [] : {};

  for (const [key, value] of entries(obj)) {
    if ((0, _isPlainObject.default)(value) || isArray(value)) {
      res[key] = await mapFiles(value, cb, ctx);
    } else {
      res[key] = await cb.call(ctx, value, key, obj);
    }
  }

  return res;
}

const mockServer = busboy => options => (0, _http.createServer)((req, res) => {
  const onData = data => mapFiles(data, async value => (0, _isFile.default)(value) ? String((await value.read())) : value);

  function onFulfilled(data) {
    res.statusCode = 200;
    res.setHeader("Content-Type", "application/json");
    res.end(JSON.stringify(data));
  }

  function onRejected(err) {
    res.statusCode = err.status || 500;
    res.end(String(err));
  }

  busboy(req, options).then(onData).then(onFulfilled, onRejected);
});

var _default = mockServer;
exports.default = _default;